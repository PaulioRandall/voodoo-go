package scanner

import (
	"github.com/PaulioRandall/voodoo-go/fault"
	"github.com/PaulioRandall/voodoo-go/token"
)

// Scan scans a line and creates an array of tokens based on
// the grammer rules of the language. Longest match is used to
// identify variable names and keywords etc.
//
// No panic is generated by the scanner so if a panic occurs it's
// either a system issue or a bug.
func Scan(s string, out chan token.Token) (err fault.Fault) {

	defer close(out)

	if s == `` {
		return
	}

	in := []rune(s)
	size := len(in)
	i := 0

	for i < size {
		var tk *token.Token
		r := in[0]

		switch {
		case isLetter(r):
			tk, in = scanWord(in, i)
		case isDigit(r):
			tk, in, err = scanNumber(in, i)
		case isSpace(r):
			tk, in = scanSpace(in, i)
		case isSpellStart(r):
			tk, in, err = scanSpell(in, i)
		case isStrStart(r):
			tk, in, err = scanString(in, i)
		case startsWith(in, `//`):
			tk = &token.Token{
				Val:  string(in),
				Type: token.COMMENT,
			}
			in = []rune{}
		default:
			tk, in, err = scanSymbol(in, i)
		}

		if err != nil {
			return
		}

		tk.Start = i
		i = size - len(in)
		tk.End = i

		out <- *tk
	}

	return
}
